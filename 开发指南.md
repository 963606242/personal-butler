# Personal Butler 开发指南

> 项目总览、安装与运行见 [README.md](README.md)。本文档描述开发状态与模块说明。

## 项目状态

### ✅ 已完成

1. **项目基础架构**
   - Electron + React 项目结构
   - Vite 构建配置
   - 路由和布局组件
   - 基础页面框架

2. **核心服务**
   - 数据库服务（SQLite）
   - 加密服务（Web Crypto API）
   - 用户状态管理（Zustand）

3. **个人信息管理**
   - ✅ 个人信息表单（基础信息：性别、年龄、身高、体重、职业）
   - ✅ 数据存储和更新
   - ✅ BMI计算
   - ✅ 工作信息管理（工作地点、工作性质、工作时间、工作日、加班频率、通勤方式、通勤时间）
   - ✅ 兴趣爱好管理（游戏、运动类型、娱乐活动、其他爱好）
   - ✅ 分标签页管理（基础信息/工作信息/兴趣爱好）
   - ✅ JSON数据存储和解析

4. **错误处理和用户体验**
   - ✅ 错误边界组件
   - ✅ 数据库异步调用修复
   - ✅ dayjs配置（中文语言包）
   - ✅ 自动用户初始化（首次使用时自动创建用户）
   - ✅ 日志系统（本地文件日志）
   - ✅ better-sqlite3 编译配置

### 🚧 进行中

1. **数据库和加密集成**
   - 完善数据库操作
   - 实现数据加密存储
   - 密钥管理

5. **日程管理**
   - ✅ 日程CRUD操作（创建、读取、更新、删除）
   - ✅ 日程列表视图
   - ✅ 日历视图（月视图）
   - ✅ 日程表单（创建/编辑）
   - ✅ 优先级管理
   - ✅ 标签管理
   - ✅ 农历显示（支持完整格式和简化格式）
   - ✅ 节假日显示（支持固定节假日和自定义节假日）
   - ✅ 日历配置（显示设置、农历格式、节假日数据源）
   - ✅ 第三方信息源配置（支持订阅外部数据源）
   - ✅ 重复规则完整实现（每天/每周/每月/每年、间隔、结束日期、每周星期）
   - ✅ 提醒功能（桌面/浏览器通知，提前 5/15/30/60 分钟等）
   - ✅ 日程冲突检测（创建/编辑时提示）
   - ✅ 日程分析统计（时间分配、空闲时间、按标签统计）

### 📋 待开发

1. **日程管理增强**
   - ✅ 农历显示功能
   - ✅ 节假日显示功能
   - ✅ 日历配置界面
   - ✅ 第三方信息源支持
   - ✅ 重复规则完整实现
   - ✅ 提醒通知功能
   - ✅ 日程冲突检测
   - ✅ 日程分析统计

2. **习惯追踪**
   - ✅ 习惯创建和管理（CRUD）
   - ✅ 时段与提醒（早晨/上午/中午/下午/傍晚/晚上/睡前，提醒时间）
   - ✅ 示例预设（早晨起床喝水、中午就餐记录、下午防久坐、晚上定点上床等）
   - ✅ 打卡功能（今日打卡 / 取消打卡）、按时段分组列表
   - ✅ 统计图表（饼图按时段/按习惯、柱状图每日完成、连续天数、完成率）
   - ✅ 习惯周报 / 月报 / 年报（完成率、各习惯明细、范围切换）

3. **装备和服装管理**
   - ✅ 装备管理（CRUD、分类筛选、搜索、图片上传）
   - ✅ 服装管理
   - ✅ 搭配推荐

4. **天气服务**
   - ✅ 天气API集成（OpenWeatherMap）
   - ✅ 城市搜索和切换
   - ✅ 天气数据缓存（30分钟）
   - ✅ 首页天气显示
   - ⏳ 穿衣推荐算法

5. **新闻资讯**
   - ✅ 新闻API集成（NewsAPI）
   - ✅ 新闻列表和分类浏览
   - ✅ 新闻搜索功能
   - ✅ 早报/晚报生成
   - ✅ 首页新闻显示（根据时间自动显示早报/晚报）

6. **AI助手**
   - Ollama集成
   - 对话功能

## 下一步开发计划

### Phase 1: 核心功能完善（当前）

1. **完善数据库服务**
   - [ ] 实现Web环境的IndexedDB支持
   - [ ] 完善数据库操作方法
   - [ ] 添加数据迁移功能

2. **完善加密服务**
   - [ ] 实现密钥派生和存储
   - [ ] 实现敏感数据加密
   - [ ] 添加密钥轮换功能

3. **完善个人信息管理**
   - [x] 工作信息管理
   - [x] 兴趣爱好管理
   - [x] 数据验证和错误处理
   - [x] JSON数据存储和解析

### Phase 2: 日程和习惯管理

1. **日程管理**
   - [x] 日程CRUD操作
   - [x] 日历视图组件（月视图）
   - [x] 日程列表视图
   - [x] 日程表单（创建/编辑）
   - [x] 优先级和标签管理
   - [x] 农历显示（chinese-lunar 库）
   - [x] 节假日显示（固定节假日 + 自定义）
   - [x] 日历配置界面（显示设置、数据源配置）
   - [x] 第三方信息源支持
   - [x] 重复规则完整实现
   - [x] 提醒功能
   - [x] 日程冲突检测

2. **习惯追踪**
   - [x] 习惯CRUD操作（含时段、频率、提醒、示例预设）
   - [x] 打卡功能、按时段分组、最近一周打卡表
   - [x] 统计和图表（饼图、柱状图、周/月/年报）
   - [x] 连续天数计算

### Phase 3: 装备和服装管理

1. **装备管理**
   - [x] 装备CRUD操作
   - [x] 图片上传和存储（Electron文件选择）
   - [x] 分类管理（电子设备/运动装备/工具/家电/其他）
   - [x] 状态管理（正常/维修/闲置/已损坏）
   - [x] 搜索和筛选功能

2. **服装管理**
   - [x] 服装CRUD操作
   - [x] 虚拟衣柜视图
   - [x] 搭配功能（搭配管理、智能推荐）

### Phase 4: 外部服务集成

1. **天气服务**
   - [ ] 天气API集成
   - [ ] 缓存机制
   - [ ] 穿衣推荐算法

2. **新闻服务**
   - [ ] 新闻API集成
   - [ ] 早报/晚报生成
   - [ ] 个性化推荐

### Phase 5: AI功能

1. **本地AI集成**
   - [ ] Ollama集成
   - [ ] 对话界面
   - [ ] 上下文管理

## 技术注意事项

### 数据库

- 使用 `better-sqlite3` 需要编译原生模块
- Web环境需要使用 IndexedDB（通过Dexie.js）
- 需要处理数据库迁移

### 加密

- Web Crypto API 只在HTTPS或localhost可用
- 需要处理密钥存储和恢复
- 考虑性能影响

### Electron

- 主进程和渲染进程通信
- 文件系统访问权限
- 原生模块加载

### 日历功能

- 使用 `chinese-lunar` 库进行农历转换
- 节假日数据支持本地存储和第三方API
- 日历配置使用 localStorage 持久化
- 支持自定义信息源订阅

## 开发命令

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 构建
npm run build

# 构建Electron应用
npm run build:electron
```

## 问题排查

### 数据库连接失败
- 检查用户数据目录权限
- 确认SQLite文件路径正确

### 加密功能不工作
- 检查是否在HTTPS环境
- 确认Web Crypto API支持

### Electron应用无法启动
- 检查Node版本（需要16+）
- 确认原生模块编译成功

### better-sqlite3 编译错误
如果遇到 `NODE_MODULE_VERSION` 不匹配的错误：
```bash
# 方法1：使用 npm rebuild（推荐）
npm rebuild better-sqlite3 --runtime=electron --target=28.0.0

# 方法2：使用 electron-rebuild
npm run rebuild

# 方法3：使用 electron-builder
npm run postinstall
```

**注意**：每次更新 Electron 版本后，都需要重新编译原生模块。
